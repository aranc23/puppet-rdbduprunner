# rdbduprunner

## Table of Contents

1. [Description](#description)
1. [Setup - The basics of getting started with rdbduprunner](#setup)
    * [What rdbduprunner affects](#what-rdbduprunner-affects)
    * [Setup requirements](#setup-requirements)
    * [Beginning with rdbduprunner](#beginning-with-rdbduprunner)
1. [Usage - Configuration options and additional functionality](#usage)
1. [Limitations - OS compatibility, etc.](#limitations)
1. [Development - Guide for contributing to the module](#development)

## Description

rdbduprunner module installs the rdbduprunner perl script, some
required perl module dependancies via the system package manager, and
will configure backupdestinations and backupsets.

For more information on rdbduprunner see the perldoc for rdbduprunner:
```
perldoc rdbduprunner
```

## Setup

### What rdbduprunner affects

rdbduprunner installs the perl script, some related configuration
files, and creates some kind of periodic execution of the script via
cron, anacron, cron.d, or systemd.

### Setup Requirements

rdbduprunner only requires perl, but the module doesn't attempt to install perl.

### Beginning with rdbduprunner

To create a simple backup of all files on the system to a local destination:
```
rdbduprunner::autobackup { 'scratch':
  destination => '/tmp/scratch',
}
```

## Usage

rdbduprunner module by itself configures no backups, with the
expecation backupdestinations and backupsets will be defined in the
conf.d directory. For legacy purposes configuration can still be made
in the per hostname config files contained in the module itself.  This
is deprecated and will officially be remo ved at some future point.

rdbduprunner can be configured using the resource like class declaration:
```
class { 'rdbduprunner':
  maxprocs => 5,
  defaultbackupdestination => 'lss',
  backupdestinations => {
    'lss' => {
      path => '/mnt/nfs/lss/lc-stor01/bob/backups',
      backup_type => 'rsync',
    }
  },
  backupsets => {
    'local' => {
      inventory => true,
      skips => ['/var'],
      excludes => ['not_backed_up'],
    },
    'local-var' => {
      inventory => false,
      paths => ['/var'],
      excludes => ['log'],
    },
  },
}
```

The same configuration can be made by including the rdbduprunner
module and using hiera:
```
rdbduprunner::maxprocs: 5
rdbduprunner::defaultbackupdestination: lss
rdbduprunner::backupdestinations:
  lss:
    path: '/mnt/nfs/lss/lc-stor01/bob/backups'
    backup_type: 'rsync'
rdbduprunner::backupsets:
  local:
    inventory: true
    skips:
      - '/var'
    excludes: ['not_backed_up']
  local-var:
    inventory: false
    paths: ['/var']
    excludes: ['log']
```

In addition there are two existing helpers for configuring both a
backupdestination and one or more backupsets that reference that
backupdestination.

rdbduprunner::backup is a class, which declares one backupdestination
and multiple (potentially) backupsets:
```
  class { 'rdbduprunner::backup':
    destination => '/mnt/lss/backups',
    prerun => '/bin/true',
    paths  => {
      '/' => [ 'opt', 'usr' ],
      '/var' => ['log'],
    }
```
This will create:
```
# generated by puppet for hostname
<BackupDestination backup>
  Path /mnt/lss/backups
  Type rsync
</BackupDestination>

<BackupSet backup_hostname_>
  Host hostname
  BackupDestination backup
  Path /
  Exclude opt
  Exclude usr
</BackupSet>
<BackupSet backup_hostname_var>
  Host hostname
  BackupDestination backup
  Path /var
  Exclude log
</BackupSet>
```

The ::autobackup define (which cannot be used multiple times, and
should be specified as a class) creates one backupdestination and one
backupset only.
```
rdbduprunner::autobackup { 'lss':
  destination => '/mnt/nfs/lc-something/userbob/backups',
  inventory => true,
  skips => ['/boot'],
  excludes => ['not_backed_up'],
}
```

rdbduprunner (the perl script) looks for files in an excludes
directory, and if a file exists there that matches the "tag" which
rdbduprunner generates for each backup, it will pass that file to
rsync using --exclude-from.  The rdbduprunner module generates these
files from the data passed to the rsync_tag_excludes and
rdbdup_tag_excludes parameters.  Tags are generated by combining the
host to be backed up and path, then replacing / with dashes and the /
path with the word root.  So, to exclude the log directory from a
backup of a-lnx005 /var, you would use a tag of a-lnx005-var.  What
follows is an hiera example of doing so:

```
rdbduprunner::rsync_tag_excludes:
  - a-lnx005-var:
    - log
```

This method of configuring rdbduprunner was formerly done with files
in the module itself.  Those are now ignored in favor of the class
parameters.  Please note: if the backupset uses the short name of a
host, use the shortname.  If it uses the FQDN, use that in the tag.

## Reference

Please see the [REFERENCES.md](REFERENCES.md) file.

## Limitations

There are no limits.

## Development

In the Development section, tell other users the ground rules for contributing
to your project and how they should submit their work.

## Release Notes/Contributors/Etc. 

See the git log for changes.
